# Sharks from Space - Overview and Improvements

This document summarizes what the project delivers today, how the pipeline is organized, and which prioritized upgrades will increase robustness, scientific value, and user experience.

---

## Recent Updates (2025-09-30)
- Optimized `scripts/02_preprocess.py` (Dask chunks + float32 + compression) to avoid RAM spikes.
- Integrated MODIS chlorophyll across download, preprocessing, feature engineering, and export; the model now uses `chlor_a` in addition to SST.
- Updated `config/config.yaml` to 2025-09-20-2025-09-25, reran scripts 01-05, and produced fresh CSVs/GeoTIFFs plus `tiles_manifest.json`.
- Fixed imports in pipeline/visualization scripts (sys.path fallback) and added `--date` arguments to comparisons, removing ModuleNotFoundError.
- Standardized scripts to rely on `scripts.utils` (load_config/project_root) and avoid duplicated relative paths.
- Rewrote `scripts/02_preprocess.py` keeping the `time` dimension, using `xr.apply_ufunc` for gradients, and preserving BBOX metadata.
- Refreshed `requirements.txt` (ASCII), adding `requests`, `pillow`, `cartopy`, and `joblib`.
- Created `scripts/utils/build_tiles_manifest.py` to generate `data/tiles/tiles_manifest.json` for the web app.
- Updated `app/index.html` to load tiles dynamically and handle missing GeoTIFFs gracefully.
- Converted the briefs to Markdown (`docs/desafio_projeto.md`, `docs/recursos_projeto.md`).
- Added `docs/guia_solucao.md` as a non-technical guide for the team.

---

## Recent Updates (2025-09-29)
- Created `scripts/utils_config.py` to centralize access to `config/config.yaml`.
- Refactored `scripts/compare_side_by_side_slider.py` to use the config BBOX, embed MODIS in base64, and accept different coordinate names.
- Adjusted `scripts/02_preprocess.py` to standardize lat/lon, preserve the time dimension, and compute gradients per timestep.
- Updated `scripts/03_feature_engineering.py` to build DataFrames with `lat`, `lon`, and `date` from the `time` axis when available.
- Revised `scripts/04_train_model.py` to consolidate features, label hotspots via top-percent gradient, and train the baseline model.
- Rewrote `scripts/05_export_tiles.py` to apply the model directly to processed NetCDFs and generate GeoTIFFs in `data/tiles/`.

---

## Overview
- Goal: predict and visualize shark feeding hotspots from NASA satellite data by combining scientific processing, feature engineering, ML, and interactive visualization.
- Inputs: NASA collections (e.g., MUR SST, MODIS CHL, PACE, ECCO, SWOT) downloaded via Earthdata.
- Outputs: processed NetCDF files, tabular feature CSVs, preview graphics (PNG/HTML), and probability rasters/tiles (GeoTIFF).
- Audience: scientists, environmental managers, educators, and the public interested in marine conservation.

---

## Pipeline Walkthrough
1. **Search & Download** - `scripts/01_search_download.py` logs into Earthdata and downloads granules according to `config/config.yaml` (BBOX + time window); currently focused on MUR SST.
2. **Scientific Preprocessing** - `scripts/02_preprocess.py` crops to the BBOX, converts SST to Celsius, and computes spatial gradients as a proxy for fronts. It preserves the `time` dimension when present and saves NetCDFs with `sst` and `sst_gradient` under `data/processed/`.
3. **Tabular Feature Engineering** - `scripts/03_feature_engineering.py` turns processed NetCDFs into tables (lat, lon, date, sst, sst_gradient, chlorophyll, MOANA metrics) stored in `data/features/`.
4. **Baseline Model Training** - `scripts/04_train_model.py` aggregates features, labels hotspots as the top-N percent of gradient per day, outputs `data/processed/dataset.csv`, and trains XGBoost (fallback to GradientBoosting).
5. **Map Products** - `scripts/05_export_tiles.py` loads the trained model, applies it to processed NetCDF slices, and exports probability GeoTIFFs to `data/tiles/`.
6. **Visualization & QA**
   - Static: `scripts/check_processed.py` generates PNG previews (SST and gradient).
   - Interactive: `scripts/check_processed_interactive.py` and `scripts/extras/plot_features_interactive.py` produce HTML dashboards.
   - Comparisons: `scripts/compare_modis_truecolor.py`, `scripts/compare_side_by_side_slider.py`, and backups in `scripts/backups/`.
   - Web app skeleton: `app/index.html` (Leaflet) overlays tiles when available.

---

## Folder Layout (summary)
- `config/config.yaml` - BBOX, dates, and dataset IDs.
- `data/raw/` - downloaded NetCDFs.
- `data/processed/` - cropped NetCDFs + gradients, consolidated dataset, model, metrics.
- `data/features/` - tabular features for ML.
- `data/tiles/` - probability GeoTIFFs generated by the model.
- `data/viz/` & `data/compare/` - interactive and comparative outputs (PNG/HTML).
- `app/index.html` - base for the Leaflet web map.
- `requirements.txt` - Python dependencies.

---

## What Already Works
- Automated download of MUR SST based on BBOX/time range.
- Cropping and gradient computation with previews (PNG/HTML) while keeping the time dimension.
- Generation of tabular features (SST + gradient + chlorophyll + MOANA) with dates derived from NetCDF metadata.
- Dataset consolidation for training with gradient-based heuristic labels; baseline model produces AUC/AP metrics.
- MODIS vs. scientific comparisons with slider (`scripts/compare_side_by_side_slider.py`) using centralized config and embedded images.
- Direct export of probability GeoTIFFs from processed NetCDFs in `data/tiles/`.

---

## Gaps and Watchpoints
- **Heuristic label** - `scripts/04_train_model.py` relies on top-N percent gradient as hotspot proxy. We should replace it with actual presence/absence data or a more physics-aware heuristic.
- **Feature coverage** - the initial model used only `sst` and `sst_gradient`; now we also export chlorophyll and MOANA metrics, but ECCO currents and other dynamics remain to be integrated.
- **Gradient units** - `scripts/02_preprocess.py` computes `np.gradient` on a geographic grid. For physical comparability across latitudes, we should convert to metric scale or reproject before gradient calculations.
- **Network fail-safe** - WMS downloads (MODIS True Color) rely on cache but still lack exponential backoff and configurable timeouts.
- **Legacy coordinate handling** - some scripts (e.g., backups) still hardcode `lat/lon` and do not reuse `utils_config.py`.

---

## Recommended Improvements

**Short term (high impact, low/medium effort)**
- Refine labels with real presence/absence data or a multi-factor heuristic (gradient + SST + CHL).
- Update remaining comparison scripts to read config via `utils_config.py`, handle coordinate aliases, and embed imagery properly.
- Add retry/backoff options to MODIS downloads and allow cached fallback without failure.

**Medium term**
- Integrate additional variables: incorporate CHL (MODIS/PACE), currents (ECCO), and mesoscale metrics (SWOT) across `02_preprocess.py` ? `03_feature_engineering.py` ? `04_train_model.py`.
- Adjust gradient calculations to metric scale (temporary reprojection or latitude-aware correction).
- Parameterize scripts via CLI to set `--start`, `--end`, `--bbox`, `--maxn` for easier reuse.
- Produce assets tailor-made for the web app (vector tiles, legends) and integrate within `app/index.html`.

**Long term**
- Advanced modeling & uncertainty: calibrate/validate with real shark tracks, add uncertainty estimates, and evaluate spatial/temporal performance.
- Distributed processing: leverage Dask for chunked arrays and parallelism across multiple days/variables.
- Automated tests: curate small fixtures in `tests/data/` and write regression checks (dimensions, ranges, expected outputs).
- Packaging & reproducibility: adopt `pyproject.toml`, version locking, or lightweight containers (conda-lock, uv, micromamba, Docker slim).
- Full web product: tile server (or libraries such as `georaster-layer-for-leaflet`), date/variable selectors, and thematic overlays.

---

## Usage Tips
- Environment setup: see the main `README.md` for creating the virtual environment and installing dependencies.
- Typical order: `01_search_download.py` ? `02_preprocess.py` ? `03_feature_engineering.py` ? inspections/plots ? `04_train_model.py` ? `05_export_tiles.py`.
- Ready-made outputs: examples in `data/compare/`, `data/viz/`, and `data/tiles/` allow validation without running the full pipeline.

---

## Final Notes
- The project is in a solid state for ingestion/preprocessing, dataset consolidation, and initial visualizations. The biggest gaps now are label quality, integration of additional variables, and operational robustness.
- The proposed priorities focus on robustness (centralized config, better labels, coordinated variables) and on moving the final product (GeoTIFFs/tiles + Leaflet app) closer to a public-ready workflow.
